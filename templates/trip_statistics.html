{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - {{ trip.title }} - Travel Planner{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{{ url_for('view_trip', trip_id=trip.id) }}" class="btn btn-outline-secondary">
        ‚Üê –ù–∞–∑–∞–¥ –¥–æ –ø–æ—ó–∑–¥–∫–∏
    </a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0"><i class="bi bi-graph-up"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—ó–∑–¥–∫–∏</h2>
        <p class="mb-0">{{ trip.title }}</p>
    </div>
</div>

<!-- –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card bg-primary text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-wallet2 stat-icon"></i>
                <h3 class="mb-1">{{ "%.2f"|format(trip.budget) }}</h3>
                <p class="mb-0">–ó–∞–≥–∞–ª—å–Ω–∏–π –±—é–¥–∂–µ—Ç</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card bg-danger text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-cash-stack stat-icon"></i>
                <h3 class="mb-1">{{ "%.2f"|format(total_spent) }}</h3>
                <p class="mb-0">–í–∏—Ç—Ä–∞—á–µ–Ω–æ</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card {% if remaining >= 0 %}bg-success{% else %}bg-warning{% endif %} text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-piggy-bank stat-icon"></i>
                <h3 class="mb-1">{{ "%.2f"|format(remaining) }}</h3>
                <p class="mb-0">{% if remaining >= 0 %}–ó–∞–ª–∏—à–æ–∫{% else %}–ü–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è{% endif %}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card stat-card bg-info text-white h-100">
            <div class="card-body text-center">
                <i class="bi bi-check-circle stat-icon"></i>
                <h3 class="mb-1">{{ "%.0f"|format(completion_rate) }}%</h3>
                <p class="mb-0">–í–∏–∫–æ–Ω–∞–Ω–æ</p>
            </div>
        </div>
    </div>
</div>

<!-- –ë—é–¥–∂–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å –±–∞—Ä -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="mb-3"><i class="bi bi-bar-chart-line"></i> –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±—é–¥–∂–µ—Ç—É</h5>
        <div class="progress" style="height: 30px;">
            {% set budget_percent = (total_spent / trip.budget * 100) if trip.budget > 0 else 0 %}
            <div class="progress-bar {% if budget_percent > 100 %}bg-danger{% elif budget_percent > 80 %}bg-warning{% else %}bg-success{% endif %}" 
                 role="progressbar" 
                 style="width: {{ [budget_percent, 100]|min }}%"
                 aria-valuenow="{{ budget_percent }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                {{ "%.1f"|format(budget_percent) }}%
            </div>
        </div>
        <p class="text-muted mt-2 mb-0">
            –í–∏—Ç—Ä–∞—á–µ–Ω–æ {{ "%.2f"|format(total_spent) }} –≥—Ä–Ω –∑ {{ "%.2f"|format(trip.budget) }} –≥—Ä–Ω
        </p>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö</h5>
    </div>
    <div class="card-body">
        {% if total_spent > 0 %}
            {% set categories = [
                ('transport', 'üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '#6c757d'),
                ('food', 'üçΩÔ∏è –á–∂–∞', '#fd7e14'),
                ('activity', 'üé° –†–æ–∑–≤–∞–≥–∏', '#20c997'),
                ('accommodation', 'üè® –ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è', '#0dcaf0'),
                ('shopping', 'üõçÔ∏è –ü–æ–∫—É–ø–∫–∏', '#d63384'),
                ('general', 'üéØ –ó–∞–≥–∞–ª—å–Ω–µ', '#6f42c1')
            ] %}
            
            {% for cat_key, cat_name, cat_color in categories %}
                {% if stats[cat_key] > 0 %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>{{ cat_name }}</span>
                            <strong>{{ "%.2f"|format(stats[cat_key]) }} –≥—Ä–Ω ({{ "%.1f"|format(stats[cat_key] / total_spent * 100) }}%)</strong>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" 
                                 style="width: {{ stats[cat_key] / total_spent * 100 }}%; background-color: {{ cat_color }};"
                                 role="progressbar">
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="text-center py-4 text-muted">
                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                <p class="mt-3">–ü–æ–∫–∏ –Ω–µ–º–∞—î –≤–∏—Ç—Ä–∞—Ç</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- –ü—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> –ü—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar bg-success" 
                         role="progressbar" 
                         style="width: {{ completion_rate }}%"
                         aria-valuenow="{{ completion_rate }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ "%.0f"|format(completion_rate) }}%
                    </div>
                </div>
                <p class="text-muted mt-2">
                    –í–∏–∫–æ–Ω–∞–Ω–æ {{ completed_activities }} –∑ {{ total_activities }} –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
                </p>
            </div>
            <div class="col-md-4 text-center">
                <div class="completion-circle">
                    <h2 class="text-success">{{ completed_activities }}/{{ total_activities }}</h2>
                    <p class="text-muted mb-0">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –≤–∏—Ç—Ä–∞—Ç -->
{% if trip.activities %}
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-table"></i> –î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –≤–∏—Ç—Ä–∞—Ç</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</th>
                        <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                        <th>–õ–æ–∫–∞—Ü—ñ—è</th>
                        <th class="text-end">–í–∞—Ä—Ç—ñ—Å—Ç—å</th>
                        <th class="text-center">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in trip.activities|sort(attribute='date') %}
                        <tr>
                            <td>{{ activity.date.strftime('%d.%m.%Y') }}</td>
                            <td>
                                <strong>{{ activity.title }}</strong>
                                {% if activity.time %}
                                    <br><small class="text-muted">{{ activity.time }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">
                                    {% if activity.category == 'transport' %}üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
                                    {% elif activity.category == 'food' %}üçΩÔ∏è –á–∂–∞
                                    {% elif activity.category == 'activity' %}üé° –†–æ–∑–≤–∞–≥–∏
                                    {% elif activity.category == 'accommodation' %}üè® –ü—Ä–æ–∂–∏–≤–∞–Ω–Ω—è
                                    {% elif activity.category == 'shopping' %}üõçÔ∏è –ü–æ–∫—É–ø–∫–∏
                                    {% else %}üéØ –ó–∞–≥–∞–ª—å–Ω–µ
                                    {% endif %}
                                </span>
                            </td>
                            <td>{{ activity.location if activity.location else '-' }}</td>
                            <td class="text-end">
                                <strong class="{% if activity.cost > 0 %}text-danger{% endif %}">
                                    {{ "%.2f"|format(activity.cost) }} –≥—Ä–Ω
                                </strong>
                            </td>
                            <td class="text-center">
                                {% if activity.completed %}
                                    <span class="badge bg-success">‚úì –í–∏–∫–æ–Ω–∞–Ω–æ</span>
                                {% else %}
                                    <span class="badge bg-secondary">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="4" class="text-end"><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</strong></td>
                        <td class="text-end"><strong class="text-danger">{{ "%.2f"|format(total_spent) }} –≥—Ä–Ω</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="text-center mt-4">
    <a href="{{ url_for('view_trip', trip_id=trip.id) }}" class="btn btn-primary">
        –ù–∞–∑–∞–¥ –¥–æ –ø–æ—ó–∑–¥–∫–∏
    </a>
</div>
{% endblock %}